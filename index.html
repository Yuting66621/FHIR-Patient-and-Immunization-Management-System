<!DOCTYPE html>
<html>

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FHIR CRUD with Immunization Records</title>

  <style>
    body {
  font-family: Helvetica;
}

table th, table td {
  border:1px solid black;
  padding: 2px 5px;
}

#json {
  width:100%;
  height:200px;
}

#inputarea {
  display:inline-block;
  vertical-align:top;
  width:45%;
  margin:2%;
}

#table {
  width:45%;
  display:inline-block;  
  vertical-align:top;
}

#table tr td, #table tr th {
  padding:2px 5px;
  border:1px solid black;
}

/* Styling for Immunization table */
#immunizationTable {
  width: 90%;
  margin: 20px auto;
  border-collapse: collapse;
}

#immunizationTable th {
  background-color: #4CAF50;
  color: white;
  text-align: left;
}

#immunizationSection {
  margin-top: 30px;
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 5px;
}

  </style>

  
</head>
<body>
  <script 
  src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js">
</script>

<h1>Patient Management System</h1>

<!-- Patient Section -->
<h2>Patient Records</h2>
<button onclick="showPatients();">Search Patients</button>
<button onclick="addPatient();">Add Patient</button>
<hr />
<table>
  <thead>
    <th>ID</th>
    <th>First Name</th>
    <th>Last Name</th>
    <th>Actions</th>
  </thead>
  <tbody id="patientResults">
    
  </tbody>
</table>

<!-- Immunization Section -->
<div id="immunizationSection">
  <h2>Immunization Records</h2>
  <p id="currentPatientInfo" style="font-weight: bold; color: #333;">
    No patient selected. Click "View Immunizations" on a patient to see their records.
  </p>
  <button onclick="addImmunization();" id="addImmunizationBtn" disabled>Add Immunization Record</button>
  <hr />
  <table id="immunizationTable">
    <thead>
      <th>Immunization ID</th>
      <th>Patient ID</th>
      <th>Vaccine Name</th>
      <th>Date Administered</th>
      <th>Status</th>
      <th>Actions</th>
    </thead>
    <tbody id="immunizationResults">
      
    </tbody>
  </table>
</div>



  <script>
    /*
NOTE: Certain operations like Update and Create seem to take a little while to "kick in" on the server.
They may be performing basic validation to prevent abuse/obscenity.
When you add or edit something, don't be thrown off by errors when searching for those names again for a few minutes.
Usually it will resolve within a few minutes.
*/

const client = FHIR.client("https://r3.smarthealthit.org");

//// Global variable to track the currently selected patient
var currentSelectedPatient = null;





//// ============ PATIENT FUNCTIONS (Original Code) ============

//// CREATE:

function addPatient() {
	//// Let's prompt the user for the pieces of info that we want to store about our new patient:
	var firstname = prompt("First name?");
	var lastname = prompt("Last name?");
  //// Let's create a minimal object structured the way a FHIR Patient resource would be structured:
	var patient = {
    "resourceType": "Patient",
    "name": {
      "given": [firstname],
      "family": lastname
    },
  }
  client.create(patient).then(function(x) {
    addPatientRow(x);
  });
  //// Or even this works:
  //client.create(patient).then(addPatientRow);
}


//// 'patient' Starts at data.entry[d].resource level in the data that client.request returns
function addPatientRow(patient) {
	//// Get a reference to patientResults tbody
  var patientResults = document.querySelector("#patientResults");
  //// Build a new table row (tr):
  var tr = document.createElement("tr");
	//// Create a table data cell (td)
	var td = document.createElement("td");
  //// Fill it with our first piece of info, which is our patient's first given name (first element in the 'given' array under the 'name' property's first entry)
  td.innerHTML = patient.id;
  tr.appendChild(td);
	//// Create a table data cell (td)
	var td = document.createElement("td");
  //// Fill it with our first piece of info, which is our patient's first given name (first element in the 'given' array under the 'name' property's first entry)
  td.innerHTML = patient.name[0].given[0];
  tr.appendChild(td);
  var td = document.createElement("td");
  td.innerHTML = patient.name[0].family;
  tr.appendChild(td);
  var td = document.createElement("td");
  var btn = document.createElement("button");
  btn.innerHTML = "[X]";
  //// You can use <function>.bind({object}) to bind values to a function when attaching it to a listener like this. That way you make sure to maintain proper references.
  
  //// We want to make sure that LATER, when we CALL the function by clicking the button (when we're not in this loop anymore), that it still knows what the right patient/data/etc is:
  btn.onclick = deletePatient
  						.bind({patient_id:patient.id, row:tr});
	//// Compare to this, where the ID will repeat incorrectly:
  //btn.onclick = function() {
  //	deletePatient(data.entry[d].resource.id);
  //}
  td.appendChild(btn);
  var btn = document.createElement("button");
  btn.innerHTML = "[Edit]";
  btn.onclick = updatePatient.bind({patient:patient, row:tr});
  td.appendChild(btn);
  
  //// NEW: Add a button to view this patient's immunizations
  var btnViewImm = document.createElement("button");
  btnViewImm.innerHTML = "[View Immunizations]";
  //// Pass both patient_id and patient_name
  var patientName = patient.name[0].given[0] + " " + patient.name[0].family;
  btnViewImm.onclick = viewPatientImmunizations.bind({
    patient_id: patient.id,
    patient_name: patientName
  });
  td.appendChild(btnViewImm);
  
  tr.appendChild(td);
	//// Append that table row (tr) to my patientResults tbody
	patientResults.appendChild(tr);
}




//// READ

function showPatients() {
	//// Basically doing this:
  //// https://r3.smarthealthit.org/Patient?name=...
	//// Keep in mind when displaying patients that this service seems to be caching requests and only refreshing every once in a while. Your changes me not immediately be apparent.
	var n = prompt("Name to search:");
  //if (confirm("Are you sure you want to pop up that name?")) {
  //	alert(lastname);
  //}
	client.request("Patient?name="+n)
  	.then(handlePatients)
    .catch(console.error)
    ;
}

function handlePatients(data) {
	//// Creating a reference to our tbody in our HTML so I can do things to change the content:
	var patientResults = document.querySelector("#patientResults");
  //// Clear the content by clearing out the innerHTML of our tbody
  patientResults.innerHTML = "";
  console.log(data);
  //return;
  //// Check to make sure 'entry' even exists as a property in our data, because that's where our array of patient results will be:
  if (data.entry) {
  	//// Then loop through it using a for-loop:
    for (var d=0; d<data.entry.length; d++) {
    	//// Sometimes the API takes a bit to process everything. Let's just have a try/catch around this to avoid complications:
      
      //try {
      	//// Here I'm calling another function that I will write to VISUALLY insert a row into my table. I'm doing this as a separate function so that I don't have to write all of the lines of code everywhere else that I want to use them.
	      addPatientRow(data.entry[d].resource);
      //} catch(error) {
      //	console.log("Skipped a patient row due to incomplete data.");
      //}
    }
  }
}






//// UPDATE
function updatePatient() {
	var firstname = prompt("First name?", this.patient.name[0].given[0]);
  if (!firstname) { return; }
	var lastname = prompt("Last name?", this.patient.name[0].family);
  if (!lastname) { return; }
  client.patch("Patient/"+this.patient.id, [
    { op: "replace", path: "/name/0/given/0", value: firstname }
    ,
    { op: "replace", path: "/name/0/family", value: lastname }
	]).then(function(updatedPatient) {
  	addPatientRow(updatedPatient);  
  });
  this.row.parentNode.removeChild(this.row);
}



//// DELETE
//function deletePatient(patient_id) {
//	console.log(patient_id);
//}
function deletePatient() {
	//// Because of our binding in addPatientRow below, we now know that we will have a 'patient_id' property and a 'row' property. 'row' will refer to the TR (table row) in the DOM that contains this particular patient record
	if (confirm("Are you sure you want to delete this patient?")) {
  	//// Whenever you 'bind' things to a function and run it, those variables are available as properties of the 'this' object
		client.delete("Patient/"+this.patient_id);
    //// Have the parent of the row we passed in remove the row from itself:
    this.row.parentNode.removeChild(this.row);
    //// Alternatively, we COULD have just re-read the entire set of results, but then we'd have to pass in the proper name search again, etc.
  }
}



//// ============ IMMUNIZATION FUNCTIONS (New Code) ============

//// View immunizations for a specific patient (called from patient row button)
function viewPatientImmunizations() {
  //// 'this' contains the patient_id and patient_name because of the .bind() we used
  //// Set the current selected patient globally
  currentSelectedPatient = {
    id: this.patient_id,
    name: this.patient_name
  };
  
  //// Update the UI to show which patient is selected
  var patientInfo = document.querySelector("#currentPatientInfo");
  patientInfo.innerHTML = "Viewing immunizations for: <span style='color: #4CAF50;'>" + 
                          this.patient_name + " (ID: " + this.patient_id + ")</span>";
  
  //// Enable the Add Immunization button
  document.querySelector("#addImmunizationBtn").disabled = false;
  
  //// Query the FHIR API for immunizations related to this patient
  client.request("Immunization?patient=" + this.patient_id)
    .then(handleImmunizations)
    .catch(function(error) {
      console.error("Error fetching immunizations:", error);
      alert("Error fetching immunizations for this patient.");
    });
}

//// Handle the immunization data returned from the API
function handleImmunizations(data) {
  var immunizationResults = document.querySelector("#immunizationResults");
  //// Clear previous results
  immunizationResults.innerHTML = "";
  
  console.log("Immunization data:", data);
  
  //// Check if we have any results
  if (data.entry && data.entry.length > 0) {
    //// Loop through each immunization record
    for (var i = 0; i < data.entry.length; i++) {
      addImmunizationRow(data.entry[i].resource);
    }
  } else {
    //// No immunizations found
    var tr = document.createElement("tr");
    var td = document.createElement("td");
    td.colSpan = 6;
    td.innerHTML = "No immunization records found for this patient.";
    td.style.textAlign = "center";
    td.style.fontStyle = "italic";
    tr.appendChild(td);
    immunizationResults.appendChild(tr);
  }
}

//// Add a single immunization record to the table
function addImmunizationRow(immunization) {
  var immunizationResults = document.querySelector("#immunizationResults");
  var tr = document.createElement("tr");
  
  //// Immunization ID
  var td = document.createElement("td");
  td.innerHTML = immunization.id || "N/A";
  tr.appendChild(td);
  
  //// Patient ID (extracted from the reference)
  var td = document.createElement("td");
  //// The patient reference is usually in format "Patient/12345"
  var patientRef = immunization.patient ? immunization.patient.reference : "N/A";
  td.innerHTML = patientRef;
  tr.appendChild(td);
  
  //// Vaccine Name
  var td = document.createElement("td");
  //// vaccineCode is a CodeableConcept with text or coding
  var vaccineName = "Unknown";
  if (immunization.vaccineCode) {
    if (immunization.vaccineCode.text) {
      vaccineName = immunization.vaccineCode.text;
    } else if (immunization.vaccineCode.coding && immunization.vaccineCode.coding.length > 0) {
      vaccineName = immunization.vaccineCode.coding[0].display || immunization.vaccineCode.coding[0].code;
    }
  }
  td.innerHTML = vaccineName;
  tr.appendChild(td);
  
  //// Date Administered
  var td = document.createElement("td");
  var dateAdministered = immunization.date || immunization.occurrenceDateTime || "N/A";
  td.innerHTML = dateAdministered;
  tr.appendChild(td);
  
  //// Status
  var td = document.createElement("td");
  td.innerHTML = immunization.status || "N/A";
  tr.appendChild(td);
  
  //// Actions
  var td = document.createElement("td");
  
  //// Delete button
  var btnDelete = document.createElement("button");
  btnDelete.innerHTML = "[X]";
  btnDelete.onclick = deleteImmunization.bind({immunization_id: immunization.id, row: tr});
  td.appendChild(btnDelete);
  
  //// Edit button
  var btnEdit = document.createElement("button");
  btnEdit.innerHTML = "[Edit]";
  btnEdit.onclick = updateImmunization.bind({immunization: immunization, row: tr});
  td.appendChild(btnEdit);
  
  tr.appendChild(td);
  immunizationResults.appendChild(tr);
}

//// CREATE: Add a new immunization record
function addImmunization() {
  //// Check if a patient is currently selected
  if (!currentSelectedPatient) {
    alert("Please select a patient first by clicking 'View Immunizations' on a patient row.");
    return;
  }
  
  var vaccineName = prompt("Vaccine name (e.g., 'COVID-19 vaccine'):");
  if (!vaccineName) {
    alert("Vaccine name is required!");
    return;
  }
  
  var dateAdministered = prompt("Date administered (YYYY-MM-DD format):");
  if (!dateAdministered) {
    alert("Date is required!");
    return;
  }
  
  //// Create an Immunization resource following FHIR structure
  //// Use the currently selected patient's ID automatically
  var immunization = {
    "resourceType": "Immunization",
    "status": "completed",
    "vaccineCode": {
      "text": vaccineName
    },
    "patient": {
      "reference": "Patient/" + currentSelectedPatient.id
    },
    "date": dateAdministered,
    "primarySource": true
  };
  
  //// Send the create request to the server
  client.create(immunization)
    .then(function(createdImmunization) {
      alert("Immunization record created successfully for " + currentSelectedPatient.name + "!");
      addImmunizationRow(createdImmunization);
    })
    .catch(function(error) {
      console.error("Error creating immunization:", error);
      alert("Error creating immunization record. Please try again.");
    });
}

//// UPDATE: Edit an existing immunization record
function updateImmunization() {
  var currentVaccineName = "";
  if (this.immunization.vaccineCode && this.immunization.vaccineCode.text) {
    currentVaccineName = this.immunization.vaccineCode.text;
  }
  
  var vaccineName = prompt("Vaccine name:", currentVaccineName);
  if (!vaccineName) { return; }
  
  var dateAdministered = prompt("Date administered (YYYY-MM-DD):", this.immunization.date || "");
  if (!dateAdministered) { return; }
  
  //// Use PATCH to update specific fields
  client.patch("Immunization/" + this.immunization.id, [
    { op: "replace", path: "/vaccineCode/text", value: vaccineName },
    { op: "replace", path: "/date", value: dateAdministered }
  ])
  .then(function(updatedImmunization) {
    alert("Immunization record updated successfully!");
    addImmunizationRow(updatedImmunization);
  })
  .catch(function(error) {
    console.error("Error updating immunization:", error);
    alert("Error updating immunization record.");
  });
  
  //// Remove the old row
  this.row.parentNode.removeChild(this.row);
}

//// DELETE: Delete an immunization record
function deleteImmunization() {
  if (confirm("Are you sure you want to delete this immunization record?")) {
    client.delete("Immunization/" + this.immunization_id)
      .then(function() {
        alert("Immunization record deleted successfully!");
      })
      .catch(function(error) {
        console.error("Error deleting immunization:", error);
        alert("Error deleting immunization record.");
      });
    
    //// Remove the row from the table
    this.row.parentNode.removeChild(this.row);
  }
}


  </script>
</body>
</html>
